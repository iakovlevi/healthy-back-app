# AGENTS.md

Этот файл задает правила работы для ИИ-агентов (Codex, Gemini, Claude Code).
Цель: быстро ориентироваться в проекте и корректно реализовывать PRD в TDD-режиме.

## Архитектура (кратко)
- `backend/`: Express API, упакован через `serverless-http` для Yandex Cloud Functions.
- `frontend/`: React SPA (CRA). Вся логика интерфейса находится в `frontend/src/app.js`.
- Взаимодействие: фронтенд обращается к API (`/auth/*`, `/data/*`) и хранит локальное состояние.
- Внешние сервисы: Yandex Database (YDB) и Yandex API Gateway (URL задан в `API_BASE_URL`).

## Важные файлы
- PRD: `docs/prd/phys-product-improvements.md`.
- Backend: `backend/server.js`.
- Frontend: `frontend/src/app.js`.
- Не трогать: `frontend/build/`, `node_modules/`.

## Как работать с PRD
1. Открой PRD и начни с раздела "Brief for agents".
2. Сопоставь требования с acceptance criteria и разложи по задачам.
3. Проверь "План валидации" и список аналитики, чтобы не забыть события.
4. Обновляй чек-листы прогресса в PRD:
   - Статусы: [ ] не начато, [~] в работе, [x] готово.
   - При завершении задачи обнови статус сразу.
5. Не меняй PRD без запроса владельца, кроме чек-листов, статуса и исправления явных противоречий (фиксируй причину).

## Definition of Done (DoD)
- Все релевантные acceptance criteria выполнены.
- Тесты проходят (frontend и backend по необходимости).
- События аналитики добавлены и соответствуют PRD.
- Чек-листы в PRD обновлены.
- Нет изменений в автогенерируемых файлах и сборочных артефактах.

## Шаблон статуса (если нужно оставить пометку)
Сделано: ... / Осталось: ... / Риски: ...

## Правила реализации
- Весь UI живет в `frontend/src/app.js`; правки вноси точечно.
- Для API и модели данных смотри `backend/server.js`.
- Поддерживай совместимость старых данных:
  - Ленивая миграция on-read.
  - Новые поля добавлять без удаления старых.
- Сохраняй ожидаемые типы данных: `history`, `painLogs`, `weights`, `achievements`, `readinessLogs`.
- Не добавляй новые зависимости без явного запроса.
- Не изменяй автогенерируемые файлы и сборочные артефакты.

## TDD (обязательно)
1. Red: сначала тесты, фиксирующие новое требование или баг.
2. Green: минимальные изменения в коде для прохождения тестов.
3. Refactor: улучшение структуры без изменения поведения.

### Рекомендации по тестам
- Backend: интеграционные тесты (Jest + Supertest) для новых типов данных.
- Frontend: RTL тесты для опросников, экрана старта, силового флоу, навигации.
- Регрессия: сохранение `history` и `painLogs`.

## Аналитика
- Используй события из "Плана валидации" PRD без переименований.
- Добавляй только недостающие события и параметры.

## Ограничения
- Никаких изменений в авторизации/регистрации.
- Никаких изменений схемы YDB (таблица `userData` остается прежней).
- Без полного редизайна UI.
