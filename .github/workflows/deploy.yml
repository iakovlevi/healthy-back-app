name: Deploy to Yandex Cloud

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure YC
        run: |
          echo "$YC_SERVICE_ACCOUNT_KEY" > sa-key.json
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH
          export PATH="$HOME/yandex-cloud/bin:$PATH"
          yc config set service-account-key sa-key.json
          # Extract Service Account ID using jq (more robust than grep)
          SA_ID=$(jq -r '.service_account_id // empty' sa-key.json)
          RUNTIME_SA_ID="${{ secrets.YC_FUNCTION_SERVICE_ACCOUNT_ID }}"
          if [ -n "$RUNTIME_SA_ID" ]; then
            SA_ID="$RUNTIME_SA_ID"
          fi
          KEY_FOLDER_ID=$(jq -r '.folder_id // empty' sa-key.json)
          FOLDER_ID="${KEY_FOLDER_ID:-${{ secrets.YC_FOLDER_ID }}}"
          yc config set folder-id "$FOLDER_ID"
          if [ -n "$SA_ID" ]; then
            echo "YC_SA_ID=$SA_ID" >> $GITHUB_ENV
          fi
          echo "YC_FOLDER_ID=$FOLDER_ID" >> $GITHUB_ENV
        env:
          YC_SERVICE_ACCOUNT_KEY: ${{ secrets.YC_SERVICE_ACCOUNT_KEY }}

      - name: Create Backend Zip
        run: |
          cd backend
          zip -r ../backend.zip . -x "node_modules/*" "__tests__/*" "jest.config.js" ".gitignore"

      - name: Deploy Backend Function
        run: |
          SA_FLAG=""
          if [ -n "$YC_SA_ID" ]; then
            SA_FLAG="--service-account-id=$YC_SA_ID"
          fi
          yc serverless function version create \
            --function-name=healthy-back-api \
            --runtime=nodejs18 \
            --entrypoint=server.handler \
            --memory=256m \
            --execution-timeout=30s \
            $SA_FLAG \
            --environment JWT_SECRET="${{ secrets.JWT_SECRET }}",YDB_ENDPOINT="${{ secrets.YDB_ENDPOINT }}",YDB_DATABASE="${{ secrets.YDB_DATABASE }}" \
            --source-path=./backend.zip

  deploy-frontend:
    runs-on: ubuntu-latest
    needs: deploy-backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Build Frontend
        run: |
          cd frontend
          npm install
          npm run build
        env:
          REACT_APP_API_BASE_URL: ${{ secrets.API_BASE_URL }}
          CI: false

      - name: Deploy to S3
        run: |
          aws configure set aws_access_key_id ${{ secrets.YC_STATIC_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.YC_STATIC_ACCESS_KEY_SECRET }}
          aws configure set default.region ru-central1
          aws s3 sync frontend/build s3://healthy-app --endpoint-url=https://storage.yandexcloud.net --acl public-read --delete
